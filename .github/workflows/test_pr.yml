name: PR Test

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  issues: read
  checks: write
  pull-requests: write

env:
  CACHED_DEPENDENCY_PATHS: ${{ github.workspace }}/node_modules
  CACHED_BUILD_PATHS: ${{ github.workspace }}/.next
  BUILD_CACHE_KEY: ${{ github.sha }}

jobs:
  job_install_dependencies:
    name: Install Dependencies
    runs-on: ubuntu-latest
    steps:
      # workflowê°€ ì‹¤í–‰ë  ë•Œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—… í…ŒìŠ¤íŠ¸ í‘¸ì‹œ
      - name: Check out current commit (${{ github.sha }})
        uses: actions/checkout@v4

      # Node í™˜ê²½ ì„¤ì • ì‘ì—…
      - name: Setup Node.js 16 ğŸš€
        uses: actions/setup-node@v4
        with:
          node-version: "16"

      # Bun ì„¤ì¹˜
      - name: Install Bun ğŸš€
        uses: oven-sh/setup-bun@v2

      # ì˜ì¡´ì„± ìºì‹œ í‚¤ ìƒì„±
      - name: Compute dependency cache key
        id: compute_lockfile_hash
        run: echo "::set-output name=hash::${{ hashFiles('**/bun.lockb') }}"

      # ì˜ì¡´ì„± ìºì‹œ í™•ì¸
      - name: Check dependency cache
        uses: actions/cache@v4
        id: cache_dependencies
        with:
          path: ${{ env.CACHED_DEPENDENCY_PATHS }}
          key: ${{ steps.compute_lockfile_hash.outputs.hash }}

      # ìºì‹œ ì—†ìœ¼ë©´ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        if: steps.cache_dependencies.outputs.cache-hit == ''
        run: bun install

    # ì˜ì¡´ì„± ìºì‹œ í‚¤ return
    outputs:
      dependency_cache_key: ${{ steps.compute_lockfile_hash.outputs.hash }}

  job_test:
    name: Test
    needs: job_install_dependencies
    runs-on: ubuntu-latest
    steps:
      # workflowê°€ ì‹¤í–‰ë  ë•Œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…
      - name: Check out current commit (${{ github.sha }})
        uses: actions/checkout@v4

      # Node í™˜ê²½ ì„¤ì • ì‘ì—…
      - name: Setup Node.js 16 ğŸš€
        uses: actions/setup-node@v4
        with:
          node-version: "16"

      # Bun ì„¤ì¹˜
      - name: Install Bun ğŸš€
        uses: oven-sh/setup-bun@v2

      # job_install_dependencies ì—ì„œ returní•œ ìºì‹œ í‚¤ë¡œ ì˜ì¡´ì„± ê°€ì ¸ì˜¤ê¸°
      - name: Check dependency cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHED_DEPENDENCY_PATHS }}
          key: ${{ needs.job_install_dependencies.outputs.dependency_cache_key }}

      # Test
      - name: Run test ğŸš“
        run: bun run vitest

      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ Comment ğŸ“‘
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          check_name: "test result"
          files: "test-results.xml"

    # job_install_dependencies ì—ì„œ returní•œ ìºì‹œ í‚¤ ê·¸ëŒ€ë¡œ return
    outputs:
      dependency_cache_key: ${{ needs.job_install_dependencies.outputs.dependency_cache_key }}

  job_build:
    name: Build
    needs: job_test
    runs-on: ubuntu-latest
    steps:
      # workflowê°€ ì‹¤í–‰ë  ë•Œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…
      - name: Check out current commit (${{ github.sha }})
        uses: actions/checkout@v4

      # Node í™˜ê²½ ì„¤ì • ì‘ì—…
      - name: Setup Node.js 16 ğŸš€
        uses: actions/setup-node@v4
        with:
          node-version: "16"

      # Bun ì„¤ì¹˜
      - name: Install Bun ğŸš€
        uses: oven-sh/setup-bun@v2

      # job_test ì—ì„œ returní•œ ìºì‹œ í‚¤ë¡œ ì˜ì¡´ì„± ê°€ì ¸ì˜¤ê¸°
      - name: Check dependency cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHED_DEPENDENCY_PATHS }}
          key: ${{ needs.job_test.outputs.dependency_cache_key }}

      # build ìºì‹œ í™•ì¸
      - name: Check build cache
        uses: actions/cache@v4
        id: cache_built_packages
        with:
          path: ${{ env.CACHED_BUILD_PATHS }}
          key: ${{ env.BUILD_CACHE_KEY }}

      # ìºì‹œ ì—†ìœ¼ë©´ build
      - name: Build packages
        if: steps.cache_built_packages.outputs.cache-hit == ''
        run: bun run build
    outputs:
      dependency_cache_key: ${{ needs.job_install_dependencies.outputs.dependency_cache_key }}
#  job_size_check:
#    name: Size Check
#    needs: job_build
#    runs-on: ubuntu-latest
#    steps:
#      # workflowê°€ ì‹¤í–‰ë  ë•Œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…
#      - name: Check out current commit (${{ github.sha }})
#        uses: actions/checkout@v4
#
#      # Node í™˜ê²½ ì„¤ì • ì‘ì—…
#      - name: Setup Node.js 16 ğŸš€
#        uses: actions/setup-node@v4
#        with:
#          node-version: "16"
#
#      - name: Check dependency cache
#        uses: actions/cache@v4
#        with:
#          path: ${{ env.CACHED_DEPENDENCY_PATHS }}
#          key: ${{ needs.job_build.outputs.dependency_cache_key }}
#
#      - name: Check build cache
#        uses: actions/cache@v4
#        with:
#          path: ${{ env.CACHED_BUILD_PATHS }}
#          key: ${{ env.BUILD_CACHE_KEY }}
#    steps:
#      # workflowê°€ ì‹¤í–‰ë  ë•Œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…
#      - name: Checkout repository ğŸ–¥ï¸
#        uses: actions/checkout@v4
#
#      # Node í™˜ê²½ ì„¤ì • ì‘ì—…
#      - name: Setup Node.js 16 ğŸš€
#        uses: actions/setup-node@v4
#        with:
#          node-version: "16"
#
#      # Bun ì„¤ì¹˜
#      - name: Install Bun ğŸš€
#        uses: oven-sh/setup-bun@v2
#
#      # ì˜ì¡´ì„± ìºì‹œ ì„¤ì •
#      - name: Cache dependencies ğŸ 
#        id: cache
#        uses: actions/cache@v4
#        with:
#          path: "**/node_modules"
#          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
#
#      # ì˜ì¡´ì„± ì„¤ì¹˜
#      - name: Install dependencies ğŸš€
#        if: steps.cache.outputs.cache-hit != 'true'
#        run: bun install
#
#      # Test
#      - name: Run test ğŸš“
#        run: bun run vitest
#
#      # Build
#      - name: Run build ğŸš›
#        run: bun run build
